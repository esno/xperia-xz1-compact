---
- name: install aosp dependencies
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - openjdk-8-jdk
    - bison
    - g++-multilib
    - git
    - gperf
    - libxml2-utils
    - make
    - zlib1g-dev:i386
    - zip
    - curl
    - bc
    - libssl-dev

- name: create directories
  file:
    dest: '{{ item.dest }}'
    state: directory
    owner: '{{ item.owner }}'
    group: '{{ item.group }}'
    mode: 0755
  with_items:
    - { dest: /opt/gradle, owner: root, group: root }
    - { dest: /opt/android, owner: user, group: user }

- name: download zipfiles
  get_url:
    url: '{{ item.url }}'
    dest: '{{ item.dest }}'
    owner: root
    group: root
    mode: 0644
  with_items:
    - { url: 'https://services.gradle.org/distributions/gradle-2.14.1-bin.zip', dest: /opt/gradle.zip }
    - { url: 'https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip', dest: /opt/sdk-tools.zip }

- name: extract zipfiles
  unarchive:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    copy: no
    owner: '{{ item.owner }}'
    group: root
    creates: '{{ item.creates }}'
  with_items:
    - { src: /opt/gradle.zip, dest: /opt/gradle, creates: /opt/gradle/gradle-2.14.1, owner: root }
    - { src: /opt/sdk-tools.zip, dest: /opt/android, creates: /opt/android/tools, owner: user }

- name: create gradle symlink
  file:
    src: /opt/gradle/gradle-2.14.1/bin/gradle
    dest: /usr/local/bin/gradle
    state: link

- name: install repo tool
  get_url:
    url: https://storage.googleapis.com/git-repo-downloads/repo
    dest: /usr/bin/repo
    owner: root
    group: root
    mode: 0755

- name: create aosp root directory
  file:
    path: /var/lib/aosp8
    owner: user
    group: user
    mode: 0755
    state: directory

- name: generate gitconfig
  template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    owner: user
    group: user
    mode: 0640
  with_items:
    - { src: home/user/.gitconfig.j2, dest: /home/user/.gitconfig }
    - { src: home/user/.bashrc.j2, dest: /home/user/.bashrc }

- name: initialize aosp tree
  shell: echo y | repo init -u https://android.googlesource.com/platform/manifest -b android-8.0.0_r15
  args:
    chdir: /var/lib/aosp8
    creates: /var/lib/aosp8/.repo
  become: yes
  become_user: user

- name: fetch manifests
  git:
    repo: https://github.com/sonyxperiadev/local_manifests.git
    dest: /var/lib/aosp8/.repo/local_manifests
    version: master
  become: yes
  become_user: user

- name: create aosp symlink
  file:
    src: /var/lib/aosp8
    dest: /home/user/aosp8
    state: link

- name: sync repos
  shell: repo sync && ./repo_update.sh
  args:
    chdir: /var/lib/aosp8
  register: taskResult
  until: taskResult == 0
  retries: 3
  delay: 1
  ignore_errors: yes
  become: yes
  become_user: user
